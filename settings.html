<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="style/share.css">
    <link rel="stylesheet" href="style/palette.css">
    <link rel="stylesheet" href="style/settings.css">
    <link rel="stylesheet" href="style/containers.css">
    <link rel="stylesheet" href="style/inputs.css">
    <link rel="shortcut icon" href="resource/favicon.png" type="image/x-icon">
</head>

<body>
    <div class="document">
        <a class="decorated" href="index.html"> <span class="icon" translate="no">arrow_back</span> Go back</a>

        <h1>Settings</h1>
        <h2>Look and feel</h2>
        <!-- #region look and feel -->
        <details name="setting">
            <summary>
                <span class="center-flex"><span class="large-icon" translate="no">palette</span>Color palette</span>
                <div>
                    <button class="text-button" onclick="savePalette()">Update</button>
                </div>
            </summary>

            <!-- Theme Selector -->
            <div class="center-flex">
                <select id="theme-selector" onchange="applySelectedTheme()">
                    <option value="">Select a theme preset</option>
                </select>
            </div>

            <!-- Color Inputs -->
            <div class="center-flex">
                <input type="color" value="#242424" name="--background-color" id="--background-color">
                <label for="--background-color">Background color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#393939" name="--card-color" id="--card-color">
                <label for="--card-color">Card color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#464646" name="--field-color" id="--field-color">
                <label for="--field-color">Field color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#666666" name="--border-color" id="--border-color">
                <label for="--border-color">Border color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#cccccc" name="--text-color" id="--text-color">
                <label for="--text-color">Text color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#ffffff" name="--icon-color" id="--icon-color">
                <label for="--icon-color">Icon color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#ffffff" name="--title-color" id="--title-color">
                <label for="--title-color">Title color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#50d3ff" name="--highlight-color" id="--highlight-color">
                <label for="--highlight-color">Highlight color</label>
            </div>
            <div class="center-flex">
                <input type="color" value="#ff7474" name="--warning-color" id="--warning-color">
                <label for="--warning-color">Warning color</label>
            </div>
        </details>

        <details name="setting">
            <summary>
                <span class="center-flex"><span class="large-icon" translate="no">brand_family</span>Font</span>
                <div>
                    <button class="text-button" onclick="resetFont()">Reset</button>
                </div>
            </summary>
            <label for="--font">Typeface</label><br>
            <input type="text" name="--font" id="--font" oninput="saveFont()" placeholder="Try 'monospace', or 'serif'"><br>

            <label for="--font-size">Size</label><br>
            <input type="range" name="--font-size" id="--font-size" min="0.5" max="1.5" value="1" step="0.1" oninput="saveFont()">
        </details>

        <details name="setting">
            <summary>
                <span class="center-flex"><span class="large-icon" translate="no">wallpaper</span>Wallpaper</span>
                <div>
                    <button class="text-button" onclick="resetWallpaper()">Reset</button>
                </div>
            </summary>
            <label for="--wallpaper">URL</label><br>
            <input type="url" name="--wallpaper" id="--wallpaper" oninput="saveWallpaper()"><br>

            <label for="--wallpaper-blur">Blur</label><br>
            <input type="range" name="--wallpaper-blur" id="--wallpaper-blur" min="0" max="10" value="0" oninput="saveWallpaper()"><br>

            <label for="--wallpaper-brightness">Brightness</label><br>
            <input type="range" name="--wallpaper-brightness" id="--wallpaper-brightness" min="0" max="2" value="1" step="0.1" oninput="saveWallpaper()"><br>

            <label for="--wallpaper-position">Position</label><br>
            <select id="--wallpaper-position" onchange="saveWallpaper()" value="center">
                <option value="center">Center</option>
                <option value="top">Top</option>
                <option value="bottom">Bottom</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
            </select>
        </details>

        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">celebration</span>Special effects</span></summary>
            <div class="switch-wrapper">
                <label class="switch">
                  <input type="checkbox" id="confetti" onchange="saveAnimations()">
                  <span class="slider"></span>
                </label>
                <span class="switch-text" title="Shows confetti when completing 100% of a list. The animation is gentle, but be aware if you're sensitive to moving visuals.">Confetti</span>
            </div>
        </details>
        <!-- #endregion -->

        <h2>Notifications</h2>
        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">notifications</span>Notifications</span></summary>   
            <button class="text-button" onclick="askForNotifications()">Ask for notification permission</button>
        </details>

        <h2>Data</h2>
        <!-- #region data -->
        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">checklist</span>Manage task book</span>
            </summary>
            <button class="danger-button" data-action="todoBook.deleteBook()" title="Clear todo list [hold]">Clear</button>
        </details>

        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">settings</span>Manage settings</span></summary>
            <button class="danger-button" data-action="clearSettings()" title="Clear settings [hold]">Clear</button>
        </details>
        <!-- #endregion -->

        <h2>TaskGPT</h2>
        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">api</span>Manage API</span></summary>
            <label for="gpt-api-key">API Key</label>
            <input type="password" name="gpt-api-key" id="gpt-api-key" onchange="localStorage.setItem('kittenGptKey', document.getElementById('gpt-api-key').value)"><br>

            <!-- <label for="gpt-model">ChatGPT Model</label><br>
            <input type="text" name="gpt-model" id="gpt-model" placeholder="Example: gpt-4.1-nano"><br> -->

            <button class="danger-button" data-action="localStorage.removeItem('kittenGptKey'); location.reload();" title="Clear my API data [hold]">Clear</button>
            <a class="decorated" href="https://platform.openai.com/" target="_blank">OpenAI Plataform</a>
        </details>

        <h2>About</h2>
        <!-- #region about -->
        <details name="setting">
            <summary><span class="center-flex"><span class="large-icon" translate="no">info</span>About Kitten</span></summary>
            <div class="center-flex break-on-mobile">
                <!-- kitten logo -->
                <div style="
                width: 50%;
                height: 300px;
                background-color: var(--highlight-color);
                -webkit-mask-image: url('resource/branding/light-full.png');
                -webkit-mask-repeat: no-repeat;
                -webkit-mask-size: contain;
                -webkit-mask-position: center;
                mask-image: url('resource/branding/light-full.png');
                mask-repeat: no-repeat;
                mask-size: contain;
                mask-position: center;
                ">
                </div>
                <div>
                    <h3>Kitten üêæ</h3>
                    <p>Kitten is an <b>accountless</b>, <b>free</b> and <b>opensource</b> tasklist manager.</p>
                    <ul>
                        <li><a class="decorated" href="docs.html?file=README.md">Documentation</a></li>
                        <li><a class="decorated" href="https://github.com/flarom/kitten/">GitHub Repository</a></li>
                        <li><a class="decorated" href="getkitten.html">Landing Page</a></li>
                        <li><a class="decorated" href="docs.html?file=PRIVACY.md">Privacy</a></li>
                        <li><a class="decorated" href="docs.html?file=LICENSE.txt">License</a></li>
                    </ul>
                </div>
            </div>
        </details>
        <!-- #endregion -->

        <script src="script/settings.js"></script>
        <script src="script/todo.js"></script>
        <script src="script/dangerbuttons.js"></script>
        <script>
            async function loadThemes() {
                const themeSelector = document.getElementById('theme-selector');
                themeSelector.innerHTML = `<option value="">Select a theme preset</option>`;

                try {
                    const response = await fetch('resource/theme/themes.json');
                    const themeFiles = await response.json();

                    const categories = {
                        Dark: [],
                        Light: [],
                        Special: []
                    };

                    for (const file of themeFiles) {
                        if (file.endsWith('.json')) {
                            const themeResponse = await fetch(`resource/theme/${file}`);
                            const theme = await themeResponse.json();
                            if (categories[theme.category]) {
                                categories[theme.category].push({ ...theme, file });
                            }
                        }
                    }

                    for (const [category, themeList] of Object.entries(categories)) {
                        if (themeList.length > 0) {
                            themeSelector.innerHTML += `<option value="" disabled>${category} themes ____________________________</option>`;
                            themeList.forEach(theme => {
                                themeSelector.innerHTML += `<option value="${theme.file}">${theme.name}</option>`;
                            });
                        }
                    }
                } catch (error) {
                    console.error('Error loading themes:', error);
                }
            }

            async function applySelectedTheme() {
                const themeSelector = document.getElementById('theme-selector');
                const selectedTheme = themeSelector.value;

                if (!selectedTheme) return;

                try {
                    const response = await fetch(`resource/theme/${selectedTheme}`);
                    const theme = await response.json();

                    for (const [key, value] of Object.entries(theme.variables)) {
                        saveSetting(key, value);
                        document.documentElement.style.setProperty(key, value);
                    }

                    const highlightColor = theme.variables['--highlight-color'];
                    const warningColor = theme.variables['--warning-color'];

                    saveSetting('--highlight-back', `${highlightColor}44`);
                    saveSetting('--warning-back', `${warningColor}44`);
                    document.documentElement.style.setProperty('--highlight-back', `${highlightColor}44`);
                    document.documentElement.style.setProperty('--warning-back', `${warningColor}44`);
                    loadPaletteIntoInputs();
                } catch (error) {
                    console.error('Error applying theme:', error);
                }
            }

            function saveColor(property, value) {
                saveSetting(property, value);

                const colorInput = document.getElementById(property);
                if (colorInput) {
                    colorInput.value = value;
                }
            }

            function savePalette() {
                const colors = [
                    '--background-color',
                    '--card-color',
                    '--field-color',
                    '--border-color',
                    '--text-color',
                    '--icon-color',
                    '--title-color',
                    '--highlight-color',
                    '--warning-color'
                ];

                colors.forEach(color => {
                    const input = document.getElementById(color);
                    if (input) {
                        saveColor(color, input.value);
                    }
                });

                const highlightColor = document.getElementById('--highlight-color').value;
                const warningColor = document.getElementById('--warning-color').value;

                saveSetting('--highlight-back', `${highlightColor}44`);
                saveSetting('--warning-back', `${warningColor}44`);
            }

            function loadPaletteIntoInputs() {
                const colors = [
                    '--background-color',
                    '--card-color',
                    '--field-color',
                    '--border-color',
                    '--text-color',
                    '--icon-color',
                    '--title-color',
                    '--highlight-color',
                    '--warning-color'
                ];

                colors.forEach(color => {
                    const savedValue = loadSetting(color);
                    const input = document.getElementById(color);
                    if (savedValue) {
                        input.value = savedValue;
                    }
                });
            }

            const fontInput = document.getElementById("--font");
            const fontSizeInput = document.getElementById("--font-size");
            fontInput.value = loadSetting('--font');
            fontSizeInput.value = loadSetting('--font-size');

            function saveFont() {
                saveSetting('--font', fontInput.value);
                saveSetting('--font-size', fontSizeInput.value);
            }

            function resetFont() {
                removeItem('--font');
                removeItem('--font-size');
                fontInput.value = "";
                fontSizeInput.value = "1";
            }

            const wallpaperInput = document.getElementById("--wallpaper");
            let storedWallpaper = loadSetting('--wallpaper');
            if (storedWallpaper?.startsWith("url('") && storedWallpaper.endsWith("')")) {
                storedWallpaper = storedWallpaper.slice(5, -2);
            }
            wallpaperInput.value = storedWallpaper || "";

            const wallpaperBlurInput = document.getElementById("--wallpaper-blur");
            let storedWallpaperBlur = loadSetting('--wallpaper-blur');
            if (storedWallpaperBlur?.endsWith("px")) {
                storedWallpaperBlur = storedWallpaperBlur.slice(0, -2);
            }
            wallpaperBlurInput.value = storedWallpaperBlur || 0;

            const wallpaperBrightnessInput = document.getElementById("--wallpaper-brightness");
            wallpaperBrightnessInput.value = loadSetting('--wallpaper-brightness');

            const wallpaperPositionInput = document.getElementById('--wallpaper-position');
            wallpaperPositionInput.value = loadSetting('--wallpaper-position');

            function saveWallpaper() {
                saveSetting('--wallpaper', `url('${wallpaperInput.value}')`);
                saveSetting('--wallpaper-blur', `${wallpaperBlurInput.value}px`);
                saveSetting('--wallpaper-brightness', wallpaperBrightnessInput.value);
                saveSetting('--wallpaper-position', wallpaperPositionInput.value);
            }

            function resetWallpaper() {
                removeItem('--wallpaper');
                removeItem('--wallpaper-blur');
                removeItem('--wallpaper-brightness');
                wallpaperInput.value = "";
            }
            
            const confettiInput = document.getElementById('confetti');
            confettiInput.checked = loadSetting('confetti') === "true";
            function saveAnimations() {
                saveSetting('confetti', confettiInput.checked);
            }

            function askForNotifications(){
                if (!("Notification" in window)) {
                    showSnackBar("This browser does not support notifications.");
                    return;
                }
                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        new Notification("Notifications will appear here", {
                            body: "You can disable notifications in your browser settings",
                            icon: "resource/favicon.png"
                        });
                    }
                });
            }

            loadPaletteIntoInputs();
            loadThemes();
            document.getElementById('gpt-api-key').value = localStorage.getItem('kittenGptKey');
        </script>
    </div>
</body>

</html>